# Chat Integration Guide

This document explains how the chat system works in the Listri application, allowing buyers to communicate with sellers about listings.

## Architecture

The chat system consists of:
- **Spring Boot WebSocket Service** (Port 8081): Handles real-time messaging
- **Next.js Frontend**: Provides the chat interface
- **STOMP Protocol**: Used for WebSocket communication

## Features

### 1. Private Conversations
- Each conversation is tied to a specific listing
- Messages are sent privately between buyer and seller
- Conversation IDs are generated based on participants and listing

### 2. Real-time Messaging
- Instant message delivery using WebSocket
- Automatic reconnection on connection loss
- Message timestamps and sender information

### 3. User Authentication
- Chat requires user login
- User IDs are used for message routing
- Anonymous users are redirected to login

## How to Use

### Starting the Services

1. **Start the Spring Boot Chat Service:**
   ```bash
   cd apps/services/chat
   ./gradlew bootRun
   ```
   The service will start on `http://localhost:8081`

2. **Start the Frontend:**
   ```bash
   cd apps/frontend
   npm run dev
   ```
   The frontend will start on `http://localhost:3000`

### Using the Chat

1. **Browse Listings:** Navigate to any listing page
2. **Contact Seller:** Click the "Contact Seller" button (requires login)
3. **Chat Interface:** A chat widget will appear in the bottom-right corner
4. **Send Messages:** Type your message and press Enter or click Send

### Testing the Chat

Visit `http://localhost:3000/chat` for a test interface where you can:
- Configure receiver ID and listing ID
- Test message sending and receiving
- Monitor connection status

## Technical Details

### Message Structure
```typescript
interface ChatMessage {
  id?: string;
  conversationId?: string;
  senderId: string;
  senderName: string;
  receiverId: string;
  content: string;
  timestamp?: string;
  listingId: string;
}
```

### WebSocket Endpoints
- **Connection:** `ws://localhost:8081/ws`
- **Send Message:** `/app/chat.private`
- **Receive Messages:** `/user/{userId}/queue/messages`
- **Join Chat:** `/app/chat.join`

### Conversation ID Generation
Conversation IDs are generated by sorting and concatenating:
- Sender ID
- Receiver ID  
- Listing ID

This ensures consistent conversation IDs regardless of who initiates the chat.

## Components

### Frontend Components
- `ChatWidget.tsx`: Main chat interface component
- `useChatSocket.ts`: Custom hook for WebSocket management
- `page.tsx` (chat): Test interface for chat functionality

### Backend Components
- `ChatController.java`: Handles message routing and processing
- `ChatMessage.java`: Message model with all required fields
- `WebSocketConfig.java`: WebSocket configuration

## Security Considerations

1. **User Authentication:** Chat requires user login
2. **Message Validation:** Messages are validated on both client and server
3. **User-specific Queues:** Messages are routed only to intended recipients
4. **CORS Configuration:** WebSocket endpoints are configured for cross-origin requests

## Troubleshooting

### Common Issues

1. **Connection Failed:**
   - Ensure Spring Boot service is running on port 8081
   - Check browser console for WebSocket errors
   - Verify CORS configuration

2. **Messages Not Received:**
   - Check if user IDs are correctly set
   - Verify WebSocket subscription is active
   - Monitor server logs for errors

3. **Chat Widget Not Appearing:**
   - Ensure user is logged in
   - Check if listing has a valid seller ID
   - Verify component imports are correct

### Debug Mode

Enable debug logging in the Spring Boot application:
```yaml
logging:
  level:
    com.listri.chat: DEBUG
    org.springframework.web.socket: DEBUG
```

## Future Enhancements

1. **Message Persistence:** Store messages in database
2. **Read Receipts:** Show when messages are read
3. **File Sharing:** Allow image/file sharing
4. **Push Notifications:** Browser notifications for new messages
5. **Chat History:** Load previous messages when opening chat
6. **Typing Indicators:** Show when someone is typing 